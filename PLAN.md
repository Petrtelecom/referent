# План реализации функций кнопок AI-обработки

## Обзор задачи

Необходимо реализовать функциональность для трех кнопок:
- **"О чем статья?"** - краткое описание содержания статьи
- **"Тезисы"** - структурированные тезисы статьи
- **"Пост для Telegram"** - пост в формате для публикации в Telegram

## Текущее состояние

- ✅ Интерфейс с кнопками уже реализован в `app/page.tsx`
- ✅ Функция `handleAction` существует, но только имитирует работу (строки 89-106)
- ✅ Есть API endpoint для парсинга статей (`/api/parse`)
- ✅ Есть API endpoint для перевода (`/api/translate`) с интеграцией OpenRouter AI
- ✅ Используется модель `deepseek/deepseek-chat` через OpenRouter
- ✅ Переменная окружения `OPENROUTER_API_KEY` уже используется

## План действий

### Этап 1: Создание API endpoint для AI-обработки

#### 1.1. Создать универсальный API endpoint `/api/ai-process`

**Файл:** `app/api/ai-process/route.ts`

**Функциональность:**
- Принимает параметры: `action` (тип действия) и `articleData` (распарсенные данные статьи)
- Поддерживает три типа действий:
  - `"summary"` - для "О чем статья?"
  - `"theses"` - для "Тезисы"
  - `"telegram-post"` - для "Пост для Telegram"
- Использует OpenRouter AI API (аналогично `/api/translate`)
- Возвращает обработанный текст на русском языке

**Структура запроса:**
```json
{
  "action": "summary" | "theses" | "telegram-post",
  "articleData": {
    "title": "string",
    "content": "string",
    "date": "string"
  }
}
```

**Промпты для каждого типа действия:**
- **summary**: "Проанализируй следующую статью и напиши краткое описание её содержания на русском языке (2-3 абзаца). Опиши основные темы, идеи и выводы."
- **theses**: "Проанализируй следующую статью и создай структурированные тезисы на русском языке. Используй формат списка с основными пунктами и подпунктами."
- **telegram-post**: "Проанализируй следующую статью и создай пост для Telegram на русском языке. Пост должен быть информативным, привлекательным, с эмодзи и хештегами. Формат: заголовок, краткое содержание, ключевые моменты, призыв к действию."

### Этап 2: Обновление фронтенда

#### 2.1. Обновить функцию `handleAction` в `app/page.tsx`

**Изменения:**
- Убрать имитацию загрузки (setTimeout)
- Добавить проверку наличия распарсенной статьи (`parsedArticle`)
- Если статья не распарсена, сначала выполнить парсинг
- Выполнить запрос к `/api/ai-process` с соответствующим типом действия
- Обработать ответ и отобразить результат
- Добавить обработку ошибок

**Логика работы:**
1. Проверить наличие URL
2. Если статья не распарсена, сначала вызвать `handleParse`
3. После успешного парсинга вызвать `/api/ai-process` с нужным `action`
4. Отобразить результат в блоке результатов

**Маппинг кнопок на типы действий:**
- "О чем статья?" → `action: "summary"`
- "Тезисы" → `action: "theses"`
- "Пост для Telegram" → `action: "telegram-post"`

#### 2.2. Улучшить UX

**Дополнительные улучшения:**
- Добавить проверку, что статья распарсена перед вызовом AI
- Показывать информативное сообщение, если статья не распарсена
- Улучшить отображение результатов (форматирование для тезисов и поста Telegram)
- Добавить возможность копирования результата в буфер обмена

### Этап 3: Обработка ошибок и валидация

#### 3.1. Валидация входных данных

**В API endpoint:**
- Проверка наличия `action` и его валидности
- Проверка наличия `articleData` и его структуры
- Проверка наличия контента статьи

#### 3.2. Обработка ошибок AI API

**Аналогично `/api/translate`:**
- Проверка наличия `OPENROUTER_API_KEY`
- Обработка ошибок API (недостаточно средств, неверный ключ, rate limit)
- Информативные сообщения об ошибках для пользователя
- Логирование ошибок в консоль

### Этап 4: Тестирование

#### 4.1. Функциональное тестирование

- Тестирование каждого типа действия с реальной статьей
- Проверка обработки ошибок (отсутствие API ключа, неверный URL, пустая статья)
- Проверка корректности форматирования результатов

#### 4.2. Интеграционное тестирование

- Проверка полного потока: парсинг → AI-обработка
- Проверка работы всех трех кнопок
- Проверка состояния загрузки и отображения результатов

## Порядок реализации (пошагово)

1. **Создать файл** `app/api/ai-process/route.ts`
   - Реализовать базовую структуру POST handler
   - Добавить валидацию входных данных
   - Реализовать логику выбора промпта в зависимости от `action`

2. **Интегрировать OpenRouter AI**
   - Использовать тот же подход, что в `/api/translate`
   - Настроить промпты для каждого типа действия
   - Обработать ответ API и вернуть результат

3. **Обновить `handleAction` в `app/page.tsx`**
   - Убрать имитацию
   - Добавить проверку `parsedArticle`
   - Реализовать вызов `/api/ai-process`
   - Обработать ответ и ошибки

4. **Добавить улучшения UX**
   - Проверка состояния парсинга перед вызовом AI
   - Информативные сообщения пользователю
   - Улучшенное форматирование результатов

5. **Тестирование**
   - Протестировать все три функции
   - Проверить обработку ошибок
   - Убедиться в корректности работы

## Технические детали

### Используемые технологии
- **Next.js** - фреймворк
- **OpenRouter AI** - AI API (модель `deepseek/deepseek-chat`)
- **TypeScript** - типизация

### Структура файлов
```
app/
  api/
    ai-process/
      route.ts          # Новый файл
    parse/
      route.ts          # Существует
    translate/
      route.ts          # Существует
  page.tsx              # Требует обновления
```

### Переменные окружения
- `OPENROUTER_API_KEY` - уже используется, дополнительных не требуется

## Критерии готовности

- ✅ Все три кнопки работают и возвращают корректные результаты
- ✅ Результаты отображаются в блоке результатов
- ✅ Обработка ошибок работает корректно
- ✅ Пользователь получает информативные сообщения об ошибках
- ✅ Код следует существующим паттернам проекта
- ✅ Нет дублирования кода (переиспользование логики из `/api/translate`)

